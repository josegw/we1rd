<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Contable</title>

<style>
:root{
--azul:#1e3a8a;
--gris:#f3f4f6;
--verde:#16a34a;
--rojo:#dc2626;
}

body{
margin:0;
font-family:Arial, Helvetica, sans-serif;
background:var(--gris);
}

header{
background:var(--azul);
color:white;
padding:15px;
text-align:center;
font-size:20px;
}

.container{
padding:20px;
max-width:1200px;
margin:auto;
}

.card{
background:white;
padding:20px;
border-radius:10px;
box-shadow:0 4px 10px rgba(0,0,0,0.1);
margin-bottom:20px;
}

input, select, button{
padding:8px;
margin:5px 0;
border-radius:6px;
border:1px solid #ccc;
}

button{
background:var(--azul);
color:white;
cursor:pointer;
border:none;
}

button:hover{opacity:0.9;}

table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}

th, td{
border:1px solid #ddd;
padding:8px;
text-align:center;
}

th{background:#e5e7eb;}

.debe{text-align:left;padding-left:20px;}
.haber{text-align:right;padding-right:20px;}

.saldo-deudor{color:var(--rojo);font-weight:bold;}
.saldo-acreedor{color:var(--verde);font-weight:bold;}

.hidden{display:none;}

.tabs button{
margin:5px 5px 5px 0;
background:#374151;
}

.tabs button.active{
background:var(--azul);
}

.alert{
position:fixed;
top:20px;
right:20px;
background:var(--rojo);
color:white;
padding:15px;
border-radius:8px;
z-index:9999;
}

.btn-eliminar{
background:var(--rojo);
padding:4px 8px;
border-radius:4px;
cursor:pointer;
}

@media(max-width:768px){
table{font-size:13px;display:block;overflow-x:auto;}
.tabs{display:flex;flex-wrap:wrap;}
}
</style>
</head>
<body>

<header>Sistema Contable - Rayado Diario</header>

<div class="container">

<div id="inicio" class="card">
<h3>Nuevo Ejercicio</h3>
<input type="text" id="empresa" placeholder="Nombre de la empresa">
<input type="date" id="fecha">
<button onclick="iniciar()">Iniciar</button>
</div>

<div id="sistema" class="hidden">

<div class="card">
<h3>Nueva Cuenta</h3>
<input type="text" id="nuevaCuenta" placeholder="Nombre de la nueva cuenta">
<button onclick="agregarCuenta()">Agregar Cuenta</button>
</div>

<div class="card">
<h3>Nueva Póliza</h3>

<select id="cuenta"></select>

<select id="tipo">
<option value="">Tipo</option>
<option value="Debe">Debe</option>
<option value="Haber">Haber</option>
</select>

<input type="number" id="monto" placeholder="Monto">

<button onclick="agregarMovimiento()">Agregar Movimiento</button>
<button onclick="finalizarPoliza()">Finalizar Póliza</button>

<h4>Vista previa de póliza actual</h4>
<div id="previewPoliza"></div>
</div>

<div class="card">
<button onclick="cerrarEjercicio()">Cerrar Ejercicio</button>
</div>

<div class="card">
<h3>Libro Diario</h3>
<div class="tabs" id="tabsPolizas"></div>
<div id="visorPoliza"></div>
</div>

<div class="card">
<h3>Cuentas T</h3>
<div id="tcuentas"></div>
</div>

<div class="card">
<h3>Balanza de Comprobación</h3>
<div id="balanza"></div>
</div>

</div>
</div>

<script>
let polizas=[];
let polizaActual=[];
let numeroPoliza=1;
let cuentas=["Caja","Clientes","Mercancías","Proveedores","Capital"];

function mostrarError(msg){
const alerta=document.createElement("div");
alerta.className="alert";
alerta.innerText=msg;
document.body.appendChild(alerta);
setTimeout(()=>alerta.remove(),3000);
}

function formato(num){
return Number(num).toLocaleString("es-MX",{minimumFractionDigits:2});
}

function iniciar(){
const empresa=document.getElementById("empresa").value.trim();
const fecha=document.getElementById("fecha").value;
if(!empresa){mostrarError("Ingresa el nombre de la empresa.");return;}
if(!fecha){mostrarError("Selecciona la fecha.");return;}
document.getElementById("inicio").classList.add("hidden");
document.getElementById("sistema").classList.remove("hidden");
renderSelectCuentas();
}

function renderSelectCuentas(){
const select=document.getElementById("cuenta");
select.innerHTML='<option value="">Selecciona cuenta</option>';
cuentas.forEach(c=>select.innerHTML+=`<option>${c}</option>`);
}

function agregarCuenta(){
const nombre=document.getElementById("nuevaCuenta").value.trim();
if(!nombre){mostrarError("Escribe el nombre.");return;}
if(cuentas.includes(nombre)){mostrarError("La cuenta ya existe.");return;}
cuentas.push(nombre);
document.getElementById("nuevaCuenta").value="";
renderSelectCuentas();
}

function agregarMovimiento(){
const cuenta=document.getElementById("cuenta").value;
const tipo=document.getElementById("tipo").value;
const monto=parseFloat(document.getElementById("monto").value);

if(!cuenta){mostrarError("Selecciona una cuenta.");return;}
if(!tipo){mostrarError("Selecciona Debe o Haber.");return;}
if(!monto||monto<=0){mostrarError("El monto debe ser mayor a 0.");return;}

polizaActual.push({cuenta,tipo,monto});
document.getElementById("monto").value="";
renderPreview();
}

function eliminarMovimiento(index){
if(!confirm("¿Deseas eliminar este movimiento?")) return;
polizaActual.splice(index,1);
renderPreview();
}

function renderPreview(){
let html=`<table>
<tr><th>Cuenta</th><th>Debe</th><th>Haber</th><th></th></tr>`;
let d=0,h=0;

polizaActual.forEach((m,i)=>{
html+=`<tr>
<td class="${m.tipo==='Debe'?'debe':'haber'}">${m.cuenta}</td>
<td>${m.tipo==='Debe'?formato(m.monto):''}</td>
<td>${m.tipo==='Haber'?formato(m.monto):''}</td>
<td><button class="btn-eliminar" onclick="eliminarMovimiento(${i})">X</button></td>
</tr>`;
if(m.tipo==="Debe") d+=m.monto; else h+=m.monto;
});

html+=`<tr><th>Total</th><th>${formato(d)}</th><th>${formato(h)}</th><th></th></tr></table>`;
document.getElementById("previewPoliza").innerHTML=html;
}

/* TODO LO DEMÁS SIGUE EXACTAMENTE IGUAL */

function finalizarPoliza(){
if(polizaActual.length===0){mostrarError("La póliza está vacía.");return;}
let d=0,h=0;
polizaActual.forEach(m=>{if(m.tipo==="Debe")d+=m.monto;else h+=m.monto;});
if(d!==h){mostrarError("La póliza no está cuadrada.");return;}
polizas.push({numero:numeroPoliza,movimientos:polizaActual});
numeroPoliza++;
polizaActual=[];
document.getElementById("previewPoliza").innerHTML="";
renderTodo();
}

function renderTodo(){renderTabs();renderCuentasT();renderBalanza();}

function renderTabs(){
let tabs="";
polizas.forEach(p=>{
tabs+=`<button onclick="verPoliza(${p.numero})">Póliza ${p.numero}</button>`;
});
document.getElementById("tabsPolizas").innerHTML=tabs;
if(polizas.length>0) verPoliza(polizas[polizas.length-1].numero);
}

function verPoliza(num){
const poliza=polizas.find(p=>p.numero===num);
let html=`<table>
<tr><th>Cuenta</th><th>Debe</th><th>Haber</th></tr>`;
poliza.movimientos.forEach(m=>{
html+=`<tr>
<td class="${m.tipo==='Debe'?'debe':'haber'}">${m.cuenta}</td>
<td>${m.tipo==='Debe'?formato(m.monto):''}</td>
<td>${m.tipo==='Haber'?formato(m.monto):''}</td>
</tr>`;
});
html+="</table>";
document.getElementById("visorPoliza").innerHTML=html;
}

function renderCuentasT(){
let cuentasT={};

polizas.forEach(p=>{
p.movimientos.forEach(m=>{
if(!cuentasT[m.cuenta])cuentasT[m.cuenta]={debe:[],haber:[]};
cuentasT[m.cuenta][m.tipo.toLowerCase()].push({
monto:m.monto,
poliza:p.numero
});
});
});

let html="";

for(let c in cuentasT){

let dTotal=0;
let hTotal=0;

html+=`
<div style="display:inline-block; margin:20px; vertical-align:top;">
<h4 style="text-align:center;">${c}</h4>

<div style="display:flex; justify-content:center; font-weight:bold;">
<div style="width:120px; text-align:left;">Debe</div>
<div style="width:2px; background:black;"></div>
<div style="width:120px; text-align:right;">Haber</div>
</div>

<div style="display:flex; justify-content:center; min-height:120px;">
<div style="width:120px; text-align:left;">
`;

cuentasT[c].debe.forEach(m=>{
dTotal+=m.monto;
html+=`P${m.poliza}: ${formato(m.monto)}<br>`;
});

html+=`</div>
<div style="width:2px; background:black;"></div>
<div style="width:120px; text-align:right;">
`;

cuentasT[c].haber.forEach(m=>{
hTotal+=m.monto;
html+=`P${m.poliza}: ${formato(m.monto)}<br>`;
});

html+=`
</div>
</div>

<div style="display:flex; justify-content:center; border-top:2px solid black; padding-top:5px;">
<div style="width:120px; text-align:left;"><strong>${formato(dTotal)}</strong></div>
<div style="width:2px;"></div>
<div style="width:120px; text-align:right;"><strong>${formato(hTotal)}</strong></div>
</div>
`;

let saldo=dTotal-hTotal;

if(saldo>0){
html+=`<div class="saldo-deudor" style="text-align:center;">Saldo Deudor: ${formato(saldo)}</div>`;
}else if(saldo<0){
html+=`<div class="saldo-acreedor" style="text-align:center;">Saldo Acreedor: ${formato(Math.abs(saldo))}</div>`;
}

html+=`</div>`;
}

document.getElementById("tcuentas").innerHTML=html;
}

function renderBalanza(){
let cuentasT={};
polizas.forEach(p=>{
p.movimientos.forEach(m=>{
if(!cuentasT[m.cuenta])cuentasT[m.cuenta]={debe:0,haber:0};
cuentasT[m.cuenta][m.tipo.toLowerCase()]+=m.monto;
});
});
let html=`<table>
<tr><th>Folio</th><th>Cuenta</th><th>Debe</th><th>Haber</th><th>Saldo Deudor</th><th>Saldo Acreedor</th></tr>`;
let i=1;
for(let c in cuentasT){
let d=cuentasT[c].debe;
let h=cuentasT[c].haber;
let saldo=d-h;
html+=`<tr>
<td>${i}</td>
<td>${c}</td>
<td>${formato(d)}</td>
<td>${formato(h)}</td>
<td>${saldo>0?formato(saldo):''}</td>
<td>${saldo<0?formato(Math.abs(saldo)):''}</td>
</tr>`;
i++;
}
html+="</table>";
document.getElementById("balanza").innerHTML=html;
}

function cerrarEjercicio(){
if(polizas.length===0){mostrarError("No hay pólizas registradas.");return;}
if(!confirm("¿Deseas cerrar el ejercicio?"))return;
location.reload();
}
</script>

</body>
</html>
